<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Karl’s Website - Minimal working example for GSEA SuSiE</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Karl’s Website</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../research.html">
 <span class="menu-text">Research Notes</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#failing-example" id="toc-failing-example" class="nav-link active" data-scroll-target="#failing-example">Failing example</a></li>
  <li><a href="#data-augmenation" id="toc-data-augmenation" class="nav-link" data-scroll-target="#data-augmenation">Data augmenation</a></li>
  <li><a href="#gibss-with-data-augmentation" id="toc-gibss-with-data-augmentation" class="nav-link" data-scroll-target="#gibss-with-data-augmentation">GIBSS with data augmentation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Minimal working example for GSEA SuSiE</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This was supposed to be a minimal working example, but when Matthew ran it he got different results than me. When I ran it again this morning I got results that agreed with his. So now this document is meant to diagnose what went wrong!</p>
<p>The MLE for the univariate doesn’t exist when the observations. When <span class="math inline">\(X\)</span> is binary (e.g.&nbsp;in GSEA) if all of the genes in the gene set are in the gene list we can always improve the likelihood by increasing the effect size. Similarly if none of the genes in the gene set are in the gene list, we can always improve the likelihood by decreasing the effect size. When we fit the GLM in these cases using <code>fastglm</code> it will return a large effect size (e.g.&nbsp;<span class="math inline">\(\hat \beta = 14\)</span>) and very large standard error <span class="math inline">\(\hat s \approx 20,000\)</span>. Consequently we get a <span class="math inline">\(z\)</span>-score close to zero, but the reported likelihood ratio (LR) can be very large, and may depends on the stopping criteria from the GLM fitting procedure. Also note that when <span class="math inline">\(y_i = 0 \;\forall i \text{ s.t. } x_i=0\)</span> the data are completely separable and the LR becomes unbounded. However, more often in our setting we will have that there is a limiting value for the LR given by the likelihood of the data in the intercept only model <em>excluding</em> the data where <span class="math inline">\(x_i=1\)</span> and <em>including</em> the observations where <span class="math inline">\(x_i = 1\)</span> (I thinks this is correct, but I need to check).</p>
<section id="failing-example" class="level3">
<h3 class="anchored" data-anchor-id="failing-example">Failing example</h3>
<div class="cell" data-hash="indx_cache/html/setup_89e44355338b69173ddc182a08675254">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github('karltayeb/logisticsusie')</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github('karltayeb/gseasusie')</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="do">##### Minimal working example</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>c1 <span class="ot">&lt;-</span> gseasusie<span class="sc">::</span><span class="fu">load_msigdb_geneset_x</span>(<span class="st">'C1'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>loading gene set from msigdbr: C1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `geneSet`</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sample random 5k background genes</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>background <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rownames</span>(c1<span class="sc">$</span>X), <span class="dv">5000</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># sample GSs to enrich, picked b0 so list is ~ 500 genes</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>enriched_gs <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">colnames</span>(c1<span class="sc">$</span>X), <span class="dv">3</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">2.2</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="sc">*</span><span class="fu">abs</span>(<span class="fu">rnorm</span>(<span class="fu">length</span>(enriched_gs)))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> b0 <span class="sc">+</span> (c1<span class="sc">$</span>X[background, enriched_gs] <span class="sc">%*%</span> b)[,<span class="dv">1</span>]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="fu">length</span>(logit), <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>logit)))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>list1 <span class="ot">&lt;-</span> background[y1<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># gene set matrix restricted to background, keep non-empty gene sets</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> c1<span class="sc">$</span>X[background,]</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> X[, Matrix<span class="sc">::</span><span class="fu">colSums</span>(X) <span class="sc">&gt;</span> <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="indx_cache/html/fit-gibss_9bf7528d3f8a3ce3fcb88b03adfe004e">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GIBSS fit</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">generalized_ibss</span>(X, y1, <span class="at">L=</span><span class="dv">10</span>, <span class="at">estimate_prior_variance =</span> F, <span class="at">maxit=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>47.875 sec elapsed</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>47.887 sec elapsed</code></pre>
</div>
</div>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-1_d365fed7d2f12d40bf2e1980ab5960ff">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span>prior_variance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> L1  L2  L3  L4  L5  L6  L7  L8  L9 L10 
  1   1   1   1   1   1   1   1   1   1 </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span>cs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$L1
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L2
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L3
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L4
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L5
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L6
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L7
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L8
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L9
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L10
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95</code></pre>
</div>
</div>
</section>
<section id="data-augmenation" class="level3">
<h3 class="anchored" data-anchor-id="data-augmenation">Data augmenation</h3>
<p>We append <span class="math inline">\((1, 0, 1, 0)\)</span> to the end of <span class="math inline">\(y\)</span> and <span class="math inline">\((a, a, 0, 0)\)</span> to each column of <span class="math inline">\(X\)</span>. We show the augmentation strategy for <span class="math inline">\(a = 1, 10\)</span>. Perhaps a better alternative is to add a very small <span class="math inline">\(l_2\)</span> penalty to the effect size <span class="math inline">\(\beta\)</span>. It turns out in this simulation 2 of the causal gene sets are <em>completely enriched</em>.</p>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-2_5c45386dc2515057632334dcada6ded1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>augment_binary_data <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, <span class="at">xval=</span><span class="dv">1</span>){</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  Xaug <span class="ot">&lt;-</span> <span class="fu">rbind</span>(X, <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(xval, xval, <span class="dv">0</span>, <span class="dv">0</span>), p), <span class="at">nrow=</span><span class="dv">4</span>))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  yaug <span class="ot">&lt;-</span> <span class="fu">c</span>(y, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">X=</span>Xaug, <span class="at">y =</span> yaug))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>causal_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colnames</span>(X) <span class="sc">%in%</span> enriched_gs)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>bad_points <span class="ot">&lt;-</span> (Matrix<span class="sc">::</span><span class="fu">t</span>(X) <span class="sc">%*%</span> y1)[, <span class="dv">1</span>] <span class="sc">==</span> <span class="dv">0</span> <span class="co">#(z &lt; 0.001) &amp; (serfit$lr &gt; 1)</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>good_points <span class="ot">&lt;-</span> <span class="sc">!</span>bad_points</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>serfit <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">fit_glm_ser</span>(X, y1, <span class="at">estimate_prior_variance =</span> T)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>labf <span class="ot">&lt;-</span> <span class="fu">with</span>(serfit, logisticsusie<span class="sc">:::</span><span class="fu">compute_log_labf</span>(betahat, shat2, lr, <span class="fl">1.</span>))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> serfit<span class="sc">$</span>betahat<span class="sc">/</span><span class="fu">sqrt</span>(serfit<span class="sc">$</span>shat2)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(labf[good_points], z[good_points], <span class="at">xlim=</span><span class="fu">range</span>(labf), <span class="at">ylim=</span><span class="fu">range</span>(z), </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">'logBF (Laplace Approximation)'</span>, <span class="at">ylab =</span> <span class="st">'z-score'</span>, <span class="at">main=</span><span class="st">'Original Data'</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(labf[bad_points], z[bad_points], <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(labf[causal_idx], z[causal_idx], <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">pch =</span> <span class="dv">22</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>augmented_data <span class="ot">&lt;-</span> <span class="fu">augment_binary_data</span>(X, y1, <span class="fl">1.</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>serfitaug <span class="ot">&lt;-</span> <span class="fu">with</span>(augmented_data, logisticsusie<span class="sc">::</span><span class="fu">fit_glm_ser</span>(X, y, <span class="at">estimate_prior_variance=</span>T))</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>labf <span class="ot">&lt;-</span> <span class="fu">with</span>(serfitaug, logisticsusie<span class="sc">:::</span><span class="fu">compute_log_labf</span>(betahat, shat2, lr, <span class="fl">1.</span>))</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">with</span>(serfitaug, betahat<span class="sc">/</span><span class="fu">sqrt</span>(shat2)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(labf[good_points], z[good_points], <span class="at">xlim=</span><span class="fu">range</span>(labf), <span class="at">ylim=</span><span class="fu">range</span>(z), </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">'logBF (Laplace Approximation)'</span>, <span class="at">ylab =</span> <span class="st">'z-score'</span>, <span class="at">main=</span><span class="st">'Augmented Data, a=1'</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(labf[bad_points], z[bad_points], <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(labf[causal_idx], z[causal_idx], <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">pch =</span> <span class="dv">22</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>augmented_data <span class="ot">&lt;-</span> <span class="fu">augment_binary_data</span>(X, y1, <span class="fl">10.</span>)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>serfitaug <span class="ot">&lt;-</span> <span class="fu">with</span>(augmented_data, logisticsusie<span class="sc">::</span><span class="fu">fit_glm_ser</span>(X, y, <span class="at">estimate_prior_variance=</span>T))</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>labf <span class="ot">&lt;-</span> <span class="fu">with</span>(serfitaug, logisticsusie<span class="sc">:::</span><span class="fu">compute_log_labf</span>(betahat, shat2, lr, <span class="fl">1.</span>))</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">with</span>(serfitaug, betahat<span class="sc">/</span><span class="fu">sqrt</span>(shat2)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(labf[good_points], z[good_points], <span class="at">xlim=</span><span class="fu">range</span>(labf), <span class="at">ylim=</span><span class="fu">range</span>(z), </span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">'logBF (Laplace Approximation)'</span>, <span class="at">ylab =</span> <span class="st">'z-score'</span>, <span class="at">main=</span><span class="st">'Augmented Data, a=10'</span>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(labf[bad_points], z[bad_points], <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(labf[causal_idx], z[causal_idx], <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">pch =</span> <span class="dv">22</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="indx_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="gibss-with-data-augmentation" class="level3">
<h3 class="anchored" data-anchor-id="gibss-with-data-augmentation">GIBSS with data augmentation</h3>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-3_a726899b86b6923c62d341d7b73eb0e0">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GIBSS fit</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>augmented_data <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">augment_binary_data</span>(X, y1, <span class="fl">1.</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">with</span>(augmented_data, logisticsusie<span class="sc">::</span><span class="fu">generalized_ibss</span>(X, y, <span class="at">L=</span><span class="dv">5</span>, <span class="at">estimate_prior_variance=</span>T, <span class="at">maxit=</span><span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in ibss_from_ser(X, y, L = L, ser_function = ser_fun, ...): Maximum
number of iterations reached</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>107.082 sec elapsed</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span>prior_variance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      L1       L2       L3       L4       L5 
38.32500 28.67109 81.14890  0.00000  0.00000 </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>107.094 sec elapsed</code></pre>
</div>
</div>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-4_59a8e96b20d16af85b16e52a19de915f">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>causal_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colnames</span>(X) <span class="sc">%in%</span> enriched_gs)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(causal_idx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  16  66 194</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span>cs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$L1
CS = {66} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L2
CS = {16} 
 alpha = {1} 
 size = 1, coverage = 1, requested = 0.95
$L3
CS = {67, 68, 75, 239, 106, 14, ...} 
 alpha = {0.11, 0.09, 0.04, 0.04, 0.03, 0.03, ...} 
 size = 62, coverage = 0.95, requested = 0.95
$L4
CS = {107, 9, 133, 131, 75, 239, ...} 
 alpha = {0.01, 0, 0, 0, 0, 0, ...} 
 size = 275, coverage = 0.952, requested = 0.95
$L5
CS = {107, 9, 133, 131, 75, 239, ...} 
 alpha = {0.01, 0, 0, 0, 0, 0, ...} 
 size = 275, coverage = 0.952, requested = 0.95</code></pre>
</div>
</div>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-5_9f2fc68c6941ef372c2fd30a281aebd2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(fit<span class="sc">$</span>cs<span class="sc">$</span>L3<span class="sc">$</span>cs <span class="sc">%in%</span> <span class="fu">which</span>(bad_points))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<ul>
<li>When the estimated prior variance is <span class="math inline">\(0\)</span> the Laplace approximation of the BF reduced to the LR, so the variables are just ranked by their LR.</li>
<li>We estimate a very large prior variance of the third effect, but the CS is very diffuse. The 3rd effect includes all of the other <em>completely enriched</em> gene sets.</li>
</ul>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-6_b246633dd3078f8d805e95591c1c0472">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">knit_exit</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-7_f52120200984f6fad9d8198b0686caf8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">fit_glm_ser</span>(X, y1, <span class="at">estimate_prior_variance =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-8_e2fe4292d3601b637140ee1af7a229c1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GIBSS fit</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>serfun <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">partial</span>(logisticsusie<span class="sc">::</span>uvbser, <span class="at">max_iter=</span><span class="dv">2</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>ser1 <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">uvbser</span>(X, y1, <span class="at">max_iter =</span> <span class="dv">20</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>o <span class="ot">&lt;-</span>( X <span class="sc">%*%</span> (ser1<span class="sc">$</span>mu <span class="sc">*</span> ser1<span class="sc">$</span>alpha))[,<span class="dv">1</span>]</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>ser2 <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">uvbser</span>(X, y1, <span class="at">o =</span> o,  <span class="at">max_iter =</span> <span class="dv">20</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">ibss_from_ser</span>(X, y1, <span class="at">L=</span><span class="dv">5</span>, <span class="at">maxit=</span><span class="dv">2</span>, <span class="at">ser_function =</span> serfun)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-9_50711ca89a3e1205eef9a12a9fbe8501">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>causal_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colnames</span>(X) <span class="sc">%in%</span> enriched_gs)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(causal_idx)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span>cs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-10_a971715df7c40d23701800a617b1d612">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' wrapper for VEB.boost to fit logistic susie</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' and tidy up output to be consistent with other susie-type outputs</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>fit_logistic_susie_veb_boost <span class="ot">=</span> <span class="cf">function</span>(X, y, <span class="at">L=</span><span class="dv">10</span>, ...){</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  veb.fit <span class="ot">=</span> VEB.Boost<span class="sc">::</span><span class="fu">veb_boost_stumps</span>(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    X, y, <span class="at">family =</span> <span class="st">'binomial'</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_stumps=</span><span class="cn">FALSE</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_log_prior_var=</span><span class="dv">35</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale_X =</span> <span class="st">'NA'</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">growMode =</span> <span class="st">'NA'</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">changeToConstant=</span>F,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">k=</span>L, ...</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(veb.fit<span class="sc">$</span>leaves, <span class="cf">function</span>(x) x<span class="sc">$</span>learner<span class="sc">$</span>currentFit<span class="sc">$</span>alpha)))</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(veb.fit<span class="sc">$</span>leaves, <span class="cf">function</span>(x) x<span class="sc">$</span>learner<span class="sc">$</span>currentFit<span class="sc">$</span>mu)))</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  mu2 <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(veb.fit<span class="sc">$</span>leaves, <span class="cf">function</span>(x) x<span class="sc">$</span>learner<span class="sc">$</span>currentFit<span class="sc">$</span>sigma2_post)))</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  mu2 <span class="ot">&lt;-</span> mu2 <span class="sc">+</span> mu<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  prior_variance <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(veb.fit<span class="sc">$</span>leaves, <span class="cf">function</span>(x) x<span class="sc">$</span>learner<span class="sc">$</span>currentFit<span class="sc">$</span>V)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  elbo <span class="ot">&lt;-</span> veb.fit<span class="sc">$</span>ELBO_progress[[<span class="dv">2</span>]]</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">alpha=</span>alpha, <span class="at">mu=</span>mu, <span class="at">mu2=</span>mu2, <span class="at">elbo=</span>elbo, <span class="at">veb.fit=</span>veb.fit, <span class="at">prior_variance=</span>prior_variance)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(res) <span class="ot">&lt;-</span> <span class="st">'susie'</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(res<span class="sc">$</span>alpha) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(res<span class="sc">$</span>mu) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>  res<span class="sc">$</span>pip <span class="ot">&lt;-</span> susieR<span class="sc">::</span><span class="fu">susie_get_pip</span>(res)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(res<span class="sc">$</span>pip) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X)</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>  res<span class="sc">$</span>sets <span class="ot">&lt;-</span> susieR<span class="sc">::</span><span class="fu">susie_get_cs</span>(res, <span class="at">X=</span>X)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>vebfit <span class="ot">&lt;-</span> <span class="fu">fit_logistic_susie_veb_boost</span>(X, y1, <span class="at">L=</span><span class="dv">10</span>)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="indx_cache/html/unnamed-chunk-11_4f56dc01c4d599d716e2c7037743b9ad">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># JJ approximation-- VEB boost</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>veb_ser <span class="ot">&lt;-</span> <span class="fu">fit_logistic_susie_veb_boost</span>(X, y1, <span class="at">L=</span><span class="dv">1</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>logisticsusie<span class="sc">::</span><span class="fu">compute_cs</span>(veb_ser<span class="sc">$</span>alpha[<span class="dv">1</span>,])</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># JJ approximation other implementation</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>jj_ser <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">binser</span>(X, y1, <span class="at">estimate_prior_variance =</span> F, <span class="at">prior_variance=</span>veb_ser<span class="sc">$</span>prior_variance)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>logisticsusie<span class="sc">::</span><span class="fu">compute_cs</span>(jj_ser<span class="sc">$</span>alpha)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># veb and my implementation agree </span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(veb_ser<span class="sc">$</span>mu, jj_ser<span class="sc">$</span>mu); <span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(veb_ser<span class="sc">$</span>alpha), <span class="fu">log</span>(jj_ser<span class="sc">$</span>alpha)); <span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co"># SER fit with Laplace</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>serfit <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">generalized_ibss</span>(X, y1, <span class="at">L=</span><span class="dv">1</span>, <span class="at">estimate_prior_variance =</span> F, <span class="at">maxit=</span><span class="dv">1</span>)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(veb_ser<span class="sc">$</span>mu, serfit<span class="sc">$</span>mu); <span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="co"># JJ approximation other implementation</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>jj_ser2 <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">binser</span>(X, y1, <span class="at">estimate_prior_variance =</span> F, <span class="at">prior_variance=</span>serfit<span class="sc">$</span>prior_variance)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>logisticsusie<span class="sc">::</span><span class="fu">compute_cs</span>(jj_ser2<span class="sc">$</span>alpha)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="co"># There is a difference between the GIBSS implementation and VB</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(serfit<span class="sc">$</span>mu, jj_ser2<span class="sc">$</span>mu); <span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(serfit<span class="sc">$</span>alpha), <span class="fu">log</span>(jj_ser2<span class="sc">$</span>alpha)); <span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="co"># the ones that don't agree are completely separated-- the MLE does not exist.</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="co"># these may also inflate the estimated prior variance the VB approach?</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a><span class="co"># are are we underestimating the prior variance in the Laplace approximation?</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>weird <span class="ot">&lt;-</span> (<span class="fu">abs</span>(serfit<span class="sc">$</span>mu[<span class="dv">1</span>,]) <span class="sc">&lt;</span> <span class="fl">0.001</span>) <span class="sc">*</span> (<span class="fu">abs</span>(jj_ser2<span class="sc">$</span>mu) <span class="sc">&gt;</span> <span class="fl">0.001</span>)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>((Matrix<span class="sc">::</span><span class="fu">t</span>(X[,weird]) <span class="sc">%*%</span> y1)[,<span class="dv">1</span>])</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="co"># repeat with augmented data</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>Xaug <span class="ot">&lt;-</span> <span class="fu">rbind</span>(X, <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="fu">ncol</span>(X)), <span class="at">nrow=</span><span class="dv">4</span>))</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>y1aug <span class="ot">&lt;-</span> <span class="fu">c</span>(y1, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="co"># JJ approximation-- VEB boost</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>veb_ser_aug <span class="ot">&lt;-</span> <span class="fu">fit_logistic_susie_veb_boost</span>(Xaug, y1aug, <span class="at">L=</span><span class="dv">1</span>)</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>logisticsusie<span class="sc">::</span><span class="fu">compute_cs</span>(veb_ser_aug<span class="sc">$</span>alpha[<span class="dv">1</span>,])</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a><span class="co"># JJ approximation other implementation</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>jj_ser_aug <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">binser</span>(Xaug, y1aug, <span class="at">estimate_prior_variance =</span> F, <span class="at">prior_variance=</span>veb_ser<span class="sc">$</span>prior_variance)</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>logisticsusie<span class="sc">::</span><span class="fu">compute_cs</span>(jj_ser_aug<span class="sc">$</span>alpha)</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a><span class="co"># veb and my implementation agree </span></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(veb_ser_aug<span class="sc">$</span>mu, jj_ser_aug<span class="sc">$</span>mu); <span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(veb_ser_aug<span class="sc">$</span>alpha), <span class="fu">log</span>(jj_ser_aug<span class="sc">$</span>alpha)); <span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a><span class="co"># SER fit with Laplace</span></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>serfit_aug <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">generalized_ibss</span>(Xaug, y1aug, <span class="at">L=</span><span class="dv">1</span>, <span class="at">estimate_prior_variance =</span> F, <span class="at">maxit=</span><span class="dv">1</span>)</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a><span class="co"># JJ approximation other implementation</span></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>jj_ser2_aug <span class="ot">&lt;-</span> logisticsusie<span class="sc">::</span><span class="fu">binser</span>(Xaug, y1aug, <span class="at">estimate_prior_variance =</span> F, <span class="at">prior_variance=</span>serfit<span class="sc">$</span>prior_variance)</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>logisticsusie<span class="sc">::</span><span class="fu">compute_cs</span>(jj_ser2_aug<span class="sc">$</span>alpha)</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a><span class="co"># There is a difference between the GIBSS implementation and VB</span></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(serfit_aug<span class="sc">$</span>mu, jj_ser2_aug<span class="sc">$</span>mu); <span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(serfit_aug<span class="sc">$</span>alpha), <span class="fu">log</span>(jj_ser2_aug<span class="sc">$</span>alpha)); <span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>