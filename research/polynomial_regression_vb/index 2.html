<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Karl Tayeb">
<meta name="dcterms.date" content="2023-03-15">
<meta name="description" content="Rough implimentation of of approximate VB regression, where we approximate the data likelihood with a polynomial. We implement a mean field gaussian variational approximation. We demonstrate the method on Gaussian linear model (no approximation), and Bernoulli-logit (logistic regression) and Poisson-log (poisson regression) models with varying approximation degree.">

<title>Karl’s Website - Implementation polynomial approximation VB</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Karl’s Website</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../research.html">
 <span class="menu-text">Research Notes</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#computation" id="toc-computation" class="nav-link active" data-scroll-target="#computation">Computation</a>
  <ul class="collapse">
  <li><a href="#chebyshev-approximations" id="toc-chebyshev-approximations" class="nav-link" data-scroll-target="#chebyshev-approximations">Chebyshev approximations</a></li>
  <li><a href="#scaling-and-shifting-polynomials" id="toc-scaling-and-shifting-polynomials" class="nav-link" data-scroll-target="#scaling-and-shifting-polynomials">Scaling and shifting polynomials</a></li>
  <li><a href="#laplace-approximation-to-polynomial" id="toc-laplace-approximation-to-polynomial" class="nav-link" data-scroll-target="#laplace-approximation-to-polynomial">Laplace approximation to polynomial</a></li>
  <li><a href="#plot-functions" id="toc-plot-functions" class="nav-link" data-scroll-target="#plot-functions">Plot functions</a></li>
  </ul></li>
  <li><a href="#gaussian-linear-regression-mean-field-approximation" id="toc-gaussian-linear-regression-mean-field-approximation" class="nav-link" data-scroll-target="#gaussian-linear-regression-mean-field-approximation">Gaussian linear regression, mean field approximation</a>
  <ul class="collapse">
  <li><a href="#polynomial-representation-of-gaussian-likelihood" id="toc-polynomial-representation-of-gaussian-likelihood" class="nav-link" data-scroll-target="#polynomial-representation-of-gaussian-likelihood">Polynomial representation of Gaussian likelihood</a></li>
  <li><a href="#mean-field-variational-approximation" id="toc-mean-field-variational-approximation" class="nav-link" data-scroll-target="#mean-field-variational-approximation">Mean field variational approximation</a></li>
  <li><a href="#computing-moment-under-q" id="toc-computing-moment-under-q" class="nav-link" data-scroll-target="#computing-moment-under-q">Computing moment under <span class="math inline">\(q\)</span></a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  <li><a href="#comparison-to-usual-bayesian-computation" id="toc-comparison-to-usual-bayesian-computation" class="nav-link" data-scroll-target="#comparison-to-usual-bayesian-computation">Comparison to usual Bayesian computation</a></li>
  </ul></li>
  <li><a href="#logistic-regression" id="toc-logistic-regression" class="nav-link" data-scroll-target="#logistic-regression">Logistic regression</a>
  <ul class="collapse">
  <li><a href="#polynomial-approximation-to-log-likelihood" id="toc-polynomial-approximation-to-log-likelihood" class="nav-link" data-scroll-target="#polynomial-approximation-to-log-likelihood">Polynomial approximation to log likelihood</a></li>
  <li><a href="#approximate-date-likelihood" id="toc-approximate-date-likelihood" class="nav-link" data-scroll-target="#approximate-date-likelihood">Approximate date likelihood</a></li>
  <li><a href="#simulate-logistic-regression" id="toc-simulate-logistic-regression" class="nav-link" data-scroll-target="#simulate-logistic-regression">Simulate logistic regression</a></li>
  <li><a href="#approximation-with-k2" id="toc-approximation-with-k2" class="nav-link" data-scroll-target="#approximation-with-k2">Approximation with <span class="math inline">\(k=2\)</span></a></li>
  <li><a href="#higher-degree-approximations" id="toc-higher-degree-approximations" class="nav-link" data-scroll-target="#higher-degree-approximations">Higher degree approximations</a></li>
  <li><a href="#compare-implimentations" id="toc-compare-implimentations" class="nav-link" data-scroll-target="#compare-implimentations">Compare implimentations</a></li>
  <li><a href="#how-does-the-posterior-approximation-change-as-we-increase-degree" id="toc-how-does-the-posterior-approximation-change-as-we-increase-degree" class="nav-link" data-scroll-target="#how-does-the-posterior-approximation-change-as-we-increase-degree">How does the posterior approximation change as we increase degree?</a></li>
  </ul></li>
  <li><a href="#poisson-regression-example" id="toc-poisson-regression-example" class="nav-link" data-scroll-target="#poisson-regression-example">Poisson regression example</a>
  <ul class="collapse">
  <li><a href="#impliment" id="toc-impliment" class="nav-link" data-scroll-target="#impliment">Impliment</a></li>
  <li><a href="#visualize-approximation" id="toc-visualize-approximation" class="nav-link" data-scroll-target="#visualize-approximation">Visualize approximation</a></li>
  <li><a href="#simulate-poisson-regression" id="toc-simulate-poisson-regression" class="nav-link" data-scroll-target="#simulate-poisson-regression">Simulate poisson regression</a></li>
  <li><a href="#example-1" id="toc-example-1" class="nav-link" data-scroll-target="#example-1">Example</a></li>
  </ul></li>
  <li><a href="#higher-degree-polynomial-posterior-q" id="toc-higher-degree-polynomial-posterior-q" class="nav-link" data-scroll-target="#higher-degree-polynomial-posterior-q">Higher degree polynomial posterior <span class="math inline">\(q\)</span></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Implimenting polynomial approximation VB</h1>
</div>

<div>
  <div class="description">
    Rough implimentation of of approximate VB regression, where we approximate the data likelihood with a polynomial. We implement a mean field gaussian variational approximation. We demonstrate the method on Gaussian linear model (no approximation), and Bernoulli-logit (logistic regression) and Poisson-log (poisson regression) models with varying approximation degree.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Karl Tayeb </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 15, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="cell" data-hash="index_cache/html/setup_877ea66ee33c61d9608816aae368712f">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pracma)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'tictoc'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:pracma':

    clear, size, tic, toc</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="computation" class="level2">
<h2 class="anchored" data-anchor-id="computation">Computation</h2>
<section id="chebyshev-approximations" class="level3">
<h3 class="anchored" data-anchor-id="chebyshev-approximations">Chebyshev approximations</h3>
<p>Chebyshev polynomials can be used to approximate functions on the interval <span class="math inline">\([-1, 1]\)</span> (and then also, on any finite interval). <span class="math inline">\(f(x) \approx \sum c_k T_k(x)\)</span>. We compute the coefficients of <span class="math inline">\(c_k\)</span> for <span class="math inline">\(k = 0, \dots K\)</span>.</p>
<p>In the code below we use <code>pracma::polyApprox</code> which implement a scheme of evaluate the coefficients for <span class="math inline">\(f\)</span>. This is essentially done via quadrature.</p>
<div class="cell" data-hash="index_cache/html/approximate-function_8f0534e7b26a85d00f8a960f33d8182f">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>make_approximation <span class="ot">&lt;-</span> <span class="cf">function</span>(f, R, n, <span class="at">plot=</span>F){</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(f, <span class="sc">-</span>R, R, <span class="at">n =</span>n)<span class="sc">$</span>p)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(plot){</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    S <span class="ot">&lt;-</span> R <span class="sc">+</span> <span class="dv">2</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span>S, S, <span class="at">by=</span><span class="fl">0.1</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(f, <span class="sc">-</span>S, S)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(x, <span class="fu">polyval2</span>(p, x), <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="st">'dotted'</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">v=</span><span class="sc">-</span>R); <span class="fu">abline</span>(<span class="at">v=</span>R)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="scaling-and-shifting-polynomials" class="level3">
<h3 class="anchored" data-anchor-id="scaling-and-shifting-polynomials">Scaling and shifting polynomials</h3>
<p>Coefficients after a change of variable</p>
<p><span class="math display">\[
f(bx) = \sum m_k (bx)^k = \sum m_k b^kx^k = \sum (m_k b^k) x^k = f_b(x)
\]</span></p>
<p><span class="math display">\[
f(x + c)
= \sum m_k (x + c)^k
= \sum_k m_k \sum_{j \leq k} {k \choose j} x^j c^{k-j}
= \sum_j \left(\sum_{k \geq j} {k \choose j} c^{k-j}\right) x^j
\]</span></p>
<div class="cell" data-hash="index_cache/html/shift-and-scale-p_50526a39777ee752b3dfd68b592e179b">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' p coefficients of a polynomial in increasing order</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param p polynomial coefficients in INCREASING deree</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>polyval2 <span class="ot">&lt;-</span> <span class="cf">function</span>(p, x){pracma<span class="sc">::</span><span class="fu">polyval</span>(<span class="fu">rev</span>(p), x)}</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' f(x + c) = f2(x)</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>shift_polynomial <span class="ot">&lt;-</span> <span class="cf">function</span>(p, c){</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># construct map</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">length</span>(p) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow=</span> K<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol=</span>K<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>K){</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>K){</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>      M[j<span class="sc">+</span><span class="dv">1</span>, k<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">choose</span>(k, j) <span class="sc">*</span> c<span class="sc">**</span>(k <span class="sc">-</span> j)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  coef_new <span class="ot">&lt;-</span> (M <span class="sc">%*%</span> p)[, <span class="dv">1</span>]</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(coef_new)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co"># change back to original scale</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># f(bx) = f2(x)</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>scale_polynomial <span class="ot">&lt;-</span> <span class="cf">function</span>(p, b){</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">length</span>(p) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  coef_new <span class="ot">&lt;-</span> p <span class="sc">*</span> <span class="fu">sapply</span>(<span class="dv">0</span><span class="sc">:</span>K, <span class="cf">function</span>(k) b<span class="sc">**</span>k)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(coef_new)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="laplace-approximation-to-polynomial" class="level3">
<h3 class="anchored" data-anchor-id="laplace-approximation-to-polynomial">Laplace approximation to polynomial</h3>
<div class="cell" data-hash="index_cache/html/convert-polynomial-density-to-gaussian_a14c2f2ad2904f390fcc9c978c8adb42">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' convert (unnormalized) polynomial density to gaussian approximation</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' p the coefficients of a polynomial in increasing order p = c(p0, p1, ..., pK)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>poly_to_gaussian <span class="ot">&lt;-</span> <span class="cf">function</span>(p){</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">rev</span>(p)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> pracma<span class="sc">::</span><span class="fu">polyder</span>(p)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  d2 <span class="ot">&lt;-</span> pracma<span class="sc">::</span><span class="fu">polyder</span>(d)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#f &lt;- function(x){polyval2(p, x)}</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mu &lt;- optimize(f, interval = c(-100, 100), maximum = T)$maximum</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  roots <span class="ot">&lt;-</span> <span class="fu">Re</span>(pracma<span class="sc">::</span><span class="fu">polyroots</span>(d)<span class="sc">$</span>root)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> roots[<span class="fu">which.max</span>(pracma<span class="sc">::</span><span class="fu">polyval</span>(p, roots))]</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  var <span class="ot">&lt;-</span> <span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> pracma<span class="sc">::</span><span class="fu">polyval</span>(d2, mu)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu=</span>mu, <span class="at">var=</span>var))</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To test it out:</p>
<div class="cell" data-hash="index_cache/html/test-shift_1743d1247d57522d317f63c016d537c3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>coef<span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>coef2 <span class="ot">&lt;-</span> <span class="fu">shift_polynomial</span>(coef, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#f(x-1) = f2(x)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">polyval2</span>(coef, <span class="dv">3</span>) <span class="sc">==</span> <span class="fu">polyval2</span>(coef2, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>coef<span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>coef2 <span class="ot">&lt;-</span> <span class="fu">scale_polynomial</span>(coef, <span class="dv">2</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># f(2x) = f2(x)</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">polyval2</span>(coef, <span class="dv">6</span>) <span class="sc">==</span> <span class="fu">polyval2</span>(coef2, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
<section id="plot-functions" class="level3">
<h3 class="anchored" data-anchor-id="plot-functions">Plot functions</h3>
<div class="cell" data-hash="index_cache/html/plot-functions_301fd680ade15c5673367de58a9afacd">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>plot_effect_posterior <span class="ot">&lt;-</span> <span class="cf">function</span>(q, b, ...){</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  mu_post <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(q, <span class="sc">~</span>purrr<span class="sc">::</span><span class="fu">pluck</span>(.x, <span class="st">'mu'</span>))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  var_post <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(q, <span class="sc">~</span>purrr<span class="sc">::</span><span class="fu">pluck</span>(.x, <span class="st">'var'</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  plotrix<span class="sc">::</span><span class="fu">plotCI</span>(</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> b,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> mu_post,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">li =</span>  mu_post <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(var_post),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">ui =</span>  mu_post <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(var_post),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="gaussian-linear-regression-mean-field-approximation" class="level2">
<h2 class="anchored" data-anchor-id="gaussian-linear-regression-mean-field-approximation">Gaussian linear regression, mean field approximation</h2>
<p>Here we illustrate a simple example of our inference technique. We fit a mean field approximation to a bivariate regression problem</p>
<p><span class="math display">\[
\begin{aligned}
y &amp;\sim N(\sum_j x_j b_j, 1)\\
b_j &amp;\sim N(0, 1)\;\; j = 1, \dots, p
\end{aligned}
\]</span></p>
<p>Where <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> are correlated (inducing dependence in the posterior <span class="math inline">\(p(b_1, b_2 | \mathcal D)\)</span>.</p>
<section id="polynomial-representation-of-gaussian-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="polynomial-representation-of-gaussian-likelihood">Polynomial representation of Gaussian likelihood</h3>
<p>For the observations</p>
<p><span class="math display">\[
l(\psi)
= C -\frac{1}{2\sigma^2}(y - \psi)^2
= C -\frac{1}{2\sigma^2} y^2 + \frac{y}{\sigma^2}\psi - \frac{1}{2\sigma^2}\psi^2 \implies {\bf m}
= (C -\frac{y^2}{2 \sigma^2}, \frac{y}{\sigma^2}, -\frac{1}{2\sigma^2})
\]</span> For the prior</p>
<p><span class="math display">\[
\log p(b) = C -\frac{1}{2\sigma^2} \left(b - \mu \right)^2
\implies {\bf m} = \left(C - \frac{\mu^2}{2\sigma^2}, \frac{\mu}{\sigma^2}, -\frac{1}{2 \sigma^2}\right)
\]</span></p>
</section>
<section id="mean-field-variational-approximation" class="level3">
<h3 class="anchored" data-anchor-id="mean-field-variational-approximation">Mean field variational approximation</h3>
<p><span class="math display">\[
\begin{aligned}
q({\bf b}) = \prod_j q(b_j) \\
q(b_j) = N(\mu_j, \sigma^2_j)
\end{aligned}
\]</span></p>
</section>
<section id="computing-moment-under-q" class="level3">
<h3 class="anchored" data-anchor-id="computing-moment-under-q">Computing moment under <span class="math inline">\(q\)</span></h3>
<p><span class="math display">\[
\mathbb E \psi_j = \mu_j x_j
\]</span></p>
<p><span class="math display">\[
\mathbb E \psi_j^2 = (\sigma^2_j + \mu^2_j) x^2_j
\]</span></p>
<p><span class="math display">\[
\bar \psi := \mathbb E_q[\psi] = \sum \mathbb E_q[\psi_j]
\]</span></p>
<p><span class="math display">\[
\bar{\psi^2} = \mathbb E_q[\psi^2] =  \mathbb E_q[ \left(\sum \psi_j \right)^2] = Var(\psi) + \bar \psi
\]</span></p>
<div class="cell" data-hash="index_cache/html/rep-gaussian-prior-as-polynomial_769aa66e54b745de48c0381ba6875cba">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' write gaussian log density as polynomial </span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' return a vector c representing polynomial c[3]x^2 + c[2] x + c[1]</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>make_gaussian_coef <span class="ot">&lt;-</span> <span class="cf">function</span>(y, <span class="at">var=</span><span class="dv">1</span>){</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> y<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>var, y<span class="sc">/</span>var, <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">/</span> var)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/compute-two-moments_f26ec68a9eca8196c1af6c74259cb0ce">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' q a p-list of distributions for effect size of each column</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' X a n x p matrix of covariate</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' returns a list(mu, mu2) with the means and second moments</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>compute_moments <span class="ot">&lt;-</span> <span class="cf">function</span>(X, q){</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  var <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> mu <span class="sc">+</span> (X[,j] <span class="sc">*</span> q[[j]]<span class="sc">$</span>mu)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    var <span class="ot">&lt;-</span> var <span class="sc">+</span> (X[,j]<span class="sc">**</span><span class="dv">2</span> <span class="sc">*</span> q[[j]]<span class="sc">$</span>var)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  mu2 <span class="ot">&lt;-</span> var <span class="sc">+</span> mu<span class="sc">**</span><span class="dv">2</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu=</span>mu, <span class="at">mu2=</span>mu2))</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' compute coeeficient for EXPECTED shift</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' f2(x) = E(f(x + c))</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>shift_polynomial2 <span class="ot">&lt;-</span> <span class="cf">function</span>(coef, mu, mu2){</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  c <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span>, mu, mu2)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># construct map</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">length</span>(coef) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow=</span> K<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol=</span>K<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>K){</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>K){</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>      M[j<span class="sc">+</span><span class="dv">1</span>, k<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">choose</span>(k, j) <span class="sc">*</span> c[[<span class="fu">max</span>(k<span class="sc">-</span>j<span class="sc">+</span><span class="dv">1</span>, <span class="dv">1</span>)]]</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  coef_new <span class="ot">&lt;-</span> (M <span class="sc">%*%</span> coef)[, <span class="dv">1</span>]</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(coef_new)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/update-polynomial-two-moments_75c8ecd55fbc8d2e6ace5b242ab9024c">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>sublist <span class="ot">&lt;-</span> <span class="cf">function</span>(list, j){</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  list[[j]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(list)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>polynomial_update2 <span class="ot">&lt;-</span> <span class="cf">function</span>(m, X, prior_p, q){</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">length</span>(q)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute moments</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># right now we just compute two moments, but need higher moments for </span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># higher degree polynomials</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    moments <span class="ot">&lt;-</span> <span class="fu">compute_moments</span>(X[, <span class="sc">-</span>j, <span class="at">drop=</span>F], <span class="fu">sublist</span>(q, j))</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># shift-- new polynomial in terms of \psi_j</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    m2_tilde <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(i) <span class="fu">shift_polynomial2</span>(</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>      m[i,], moments<span class="sc">$</span>mu[i], moments<span class="sc">$</span>mu2[i])))</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale-- new polynomial in terms of b_j</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    m2_hat <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(i) <span class="fu">scale_polynomial</span>(m2_tilde[i,], X[i, j])))</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute posterior polynomial</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    m2_post <span class="ot">&lt;-</span> <span class="fu">colSums</span>(m2_hat) <span class="sc">+</span> prior_p[[j]]</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># find gaussian approximation</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    q[[j]] <span class="ot">&lt;-</span> <span class="fu">poly_to_gaussian</span>(m2_post)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(q)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="example" class="level3">
<h3 class="anchored" data-anchor-id="example">Example</h3>
<div class="cell" data-hash="index_cache/html/simulate-linear-regression_687d746fe479f332652623bc6c1ca14a">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>simulate <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">500</span>, <span class="at">p=</span><span class="dv">2</span>, <span class="at">lenghtscale =</span> <span class="fl">0.8</span>, <span class="at">prior_variance=</span><span class="dv">5</span>){</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>p), <span class="at">nrow=</span>n)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="fu">outer</span>(<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="st">'-'</span>)<span class="sc">/</span>lenghtscale)<span class="sc">**</span><span class="dv">2</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> Z <span class="sc">%*%</span> K</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p) <span class="sc">*</span> <span class="fu">sqrt</span>(prior_variance)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> (X <span class="sc">%*%</span> b)[, <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">y=</span>y, <span class="at">X=</span>X, <span class="at">b=</span>b))</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">simulate</span>(<span class="at">p=</span><span class="dv">3</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> sim<span class="sc">$</span>y</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> sim<span class="sc">$</span>X</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> sim<span class="sc">$</span>b</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1.900755 -2.069063  1.998108</code></pre>
</div>
</div>
<div class="cell" data-hash="index_cache/html/fit-polynomial-linear-regression_c69b7da1c10fc189a214907d57dd5e0d">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># observations in polynomial coeeficients</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(y, make_gaussian_coef))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize prior and q</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>prior_p <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  prior_p[[j]] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  q[[j]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">var=</span><span class="dv">1</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co"># iteratively update</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>param_history <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>param_history[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> q</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>){</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">polynomial_update2</span>(m, X, prior_p, q)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  param_history[[i<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> q</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>mu_post <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(q, <span class="sc">~</span>purrr<span class="sc">::</span><span class="fu">pluck</span>(.x, <span class="st">'mu'</span>))</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>var_post <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(q, <span class="sc">~</span>purrr<span class="sc">::</span><span class="fu">pluck</span>(.x, <span class="st">'var'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here we simulate a gaussian linear mode with three covariates. We plot the simulated effects against their posteror mean. It looks like we are able to recover the effects. Nice!</p>
<div class="cell" data-hash="index_cache/html/plot-posterior-linear-regression_4acf590188f123de1eef3352aea24132">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(q, sim<span class="sc">$</span>b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot-posterior-linear-regression-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="comparison-to-usual-bayesian-computation" class="level3">
<h3 class="anchored" data-anchor-id="comparison-to-usual-bayesian-computation">Comparison to usual Bayesian computation</h3>
<p>TODO</p>
</section>
</section>
<section id="logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="logistic-regression">Logistic regression</h2>
<p>Next we will take a quadratic approximation for logistic regression. We will also test higher degree polynomial approximations. In all cases we continue to use a Gaussian mean-field variational approximation. Computing the moments of the higher degree polynomials may be tricky, so we defer for now. However, if it can be done easily we may benefit from the richer varitional approximation (note: the Gaussian distribution is a degree 2 polynomial exponential family since it’s sufficient statistics are <span class="math inline">\(T(x) = [x, x^2]\)</span>)</p>
<section id="polynomial-approximation-to-log-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="polynomial-approximation-to-log-likelihood">Polynomial approximation to log likelihood</h3>
<p>For each data point we want to approximate the log likelihood as a function of the linear predictor</p>
<p><span class="math display">\[
\log p(y | \psi) = y\psi + \log \sigma(-\psi)
\]</span></p>
<p>Here we plot the <span class="math inline">\(\log p(y=0 | \psi)\)</span> and it’s polynomial approximations of degree <span class="math inline">\(k=2,4,6,8\)</span>.</p>
<p>These polynomial approximations are generated using <code>pracma::polyApprox</code> which use the Chebyshev coefficients of an appropriately rescaled version of the function, to generate a polynomial approximation on the interval <span class="math inline">\([a, b]\)</span>. We generate approximations on the interval <span class="math inline">\([-R, R]\)</span> where <span class="math inline">\(R = 3\)</span>.</p>
<div class="cell" data-hash="index_cache/html/approximate-conditional-likelihood-logistic-regression_b99c3662903f8a34d532fe48b879c922">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loglike functions for y=1 and y=0</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>loglik1 <span class="ot">&lt;-</span> <span class="cf">function</span>(psi){</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  psi <span class="sc">+</span> <span class="fu">log</span>(<span class="fu">sigmoid</span>(<span class="sc">-</span>psi))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>loglik0 <span class="ot">&lt;-</span> <span class="cf">function</span>(psi){</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(<span class="fu">sigmoid</span>(<span class="sc">-</span>psi))</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># polynomial approximation via pracma</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>ll0_p2 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(loglik0, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">2</span>)<span class="sc">$</span>p)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>ll0_p4 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(loglik0, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">4</span>)<span class="sc">$</span>p)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>ll0_p6 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(loglik0, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">6</span>)<span class="sc">$</span>p)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>ll0_p8 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(loglik0, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">8</span>)<span class="sc">$</span>p)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co"># note: ll0 and ll1 are just reflections over the x axis</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co"># so we can get ll1 by taking ll0_p2 and flipping the sign of the linear term</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>ll1_p2 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(loglik1, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">2</span>)<span class="sc">$</span>p)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>ll1_p4 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(loglik1, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">4</span>)<span class="sc">$</span>p)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>ll1_p6 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(loglik1, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">6</span>)<span class="sc">$</span>p)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>ll1_p8 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(loglik1, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">8</span>)<span class="sc">$</span>p)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> R <span class="sc">+</span> <span class="dv">2</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span>S, S, <span class="at">by=</span><span class="fl">0.1</span>)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(loglik0, <span class="sc">-</span>S, S)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">polyval2</span>(ll0_p2, x), <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="st">'dotted'</span>)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">polyval2</span>(ll0_p4, x), <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="st">'dotted'</span>)</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">polyval2</span>(ll0_p6, x), <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="st">'dotted'</span>)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">polyval2</span>(ll0_p8, x), <span class="at">col=</span><span class="st">'orange'</span>, <span class="at">lty=</span><span class="st">'dotted'</span>)</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>R); <span class="fu">abline</span>(<span class="at">v=</span><span class="sc">-</span>R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/approximate-conditional-likelihood-logistic-regression-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="approximate-date-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="approximate-date-likelihood">Approximate date likelihood</h3>
<p>This just takes a whoe list of vector <span class="math inline">\(y\)</span> and returns a matrix of coefficients</p>
<div class="cell" data-hash="index_cache/html/compute-coefficients-logistic-regression_e2383c2e05de018fdde65d06590d582d">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' get approximate polynomial representation of the data y</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>bernoulli_poly_approx <span class="ot">&lt;-</span> <span class="cf">function</span>(y, R, k){</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  p0 <span class="ot">&lt;-</span> <span class="fu">make_approximation</span>(loglik0, R, k)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for y=1 flip the sign of odd coefficients (note: 0 indexing)</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> p0</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  p1[<span class="fu">seq</span>(<span class="dv">2</span>, <span class="fu">length</span>(p0), <span class="at">by=</span><span class="dv">2</span>)] <span class="ot">&lt;-</span> p1[<span class="fu">seq</span>(<span class="dv">2</span>, <span class="fu">length</span>(p0), <span class="at">by=</span><span class="dv">2</span>)] <span class="sc">*</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> n, <span class="at">ncol =</span> k <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(y)){</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(y[i] <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>      m[i,] <span class="ot">&lt;-</span> p0</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>      m[i,] <span class="ot">&lt;-</span> p1</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(m)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="simulate-logistic-regression" class="level3">
<h3 class="anchored" data-anchor-id="simulate-logistic-regression">Simulate logistic regression</h3>
<div class="cell" data-hash="index_cache/html/simulate-logistic-regression_62050d945578c6b15db1f2e1b4282a67">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>simulate_lr <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">500</span>, <span class="at">p=</span><span class="dv">2</span>, <span class="at">lenghtscale =</span> <span class="fl">0.8</span>, <span class="at">prior_variance=</span><span class="dv">5</span>){</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>p), <span class="at">nrow=</span>n)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="fu">outer</span>(<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="st">'-'</span>)<span class="sc">/</span>lenghtscale)<span class="sc">**</span><span class="dv">2</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> Z <span class="sc">%*%</span> K</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p) <span class="sc">*</span> <span class="fu">sqrt</span>(prior_variance)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  logits <span class="ot">&lt;-</span> (X <span class="sc">%*%</span> b)[, <span class="dv">1</span>]</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="fu">length</span>(logits), <span class="dv">1</span>, <span class="fu">sigmoid</span>(logits))</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">y=</span>y, <span class="at">X=</span>X, <span class="at">b=</span>b, <span class="at">logits=</span>logits))</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="approximation-with-k2" class="level3">
<h3 class="anchored" data-anchor-id="approximation-with-k2">Approximation with <span class="math inline">\(k=2\)</span></h3>
<p>We can reuse our code above, substituting in new “data”, the coefficients for the polynomial approximation to the conditional likelihood.</p>
<div class="cell" data-hash="index_cache/html/fit-logistic-k2-approximation_2f605e148c7a2727564448e76b3423b8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>logistic_polynomial_approximation_k2 <span class="ot">&lt;-</span> <span class="cf">function</span>(y, X, R){</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># observations in polynomial coeeficients</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">bernoulli_poly_approx</span>(y, R, <span class="at">k=</span><span class="dv">2</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># initialize prior and q</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  prior_p <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    prior_p[[j]] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    q[[j]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">var=</span><span class="dv">1</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># iteratively update</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  param_history <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  param_history[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> q</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>){</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    q <span class="ot">&lt;-</span> <span class="fu">polynomial_update2</span>(m, X, prior_p, q)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    param_history[[i<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> q</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(param_history)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A 2d approximation does not seem to perform very well here.</p>
<div class="cell" data-hash="index_cache/html/fit-logistic-regression-k2_edee14b81ef6e39f287d6767d793139e">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>lenghtscale <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>prior_variance <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>p), <span class="at">nrow=</span>n)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="fu">outer</span>(<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="st">'-'</span>)<span class="sc">/</span>lenghtscale)<span class="sc">**</span><span class="dv">2</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> Z <span class="sc">%*%</span> K</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p) <span class="sc">*</span> <span class="fu">sqrt</span>(prior_variance)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>logits <span class="ot">&lt;-</span> (X <span class="sc">%*%</span> b)[, <span class="dv">1</span>]</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="fu">length</span>(logits), <span class="dv">1</span>, <span class="fu">sigmoid</span>(logits))</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.3319418 0.3807557 5.4429687</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>qs <span class="ot">&lt;-</span> <span class="fu">logistic_polynomial_approximation_k2</span>(y, X, <span class="at">R=</span><span class="dv">5</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">tail</span>(qs, <span class="dv">1</span>)[[<span class="dv">1</span>]]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>mu_post <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(q, <span class="sc">~</span>purrr<span class="sc">::</span><span class="fu">pluck</span>(.x, <span class="st">'mu'</span>))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>var_post <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(q, <span class="sc">~</span>purrr<span class="sc">::</span><span class="fu">pluck</span>(.x, <span class="st">'var'</span>))</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>plotrix<span class="sc">::</span><span class="fu">plotCI</span>(</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> b,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> mu_post,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">li =</span>  mu_post <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(var_post),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">ui =</span>  mu_post <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(var_post)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col=</span><span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/fit-logistic-regression-k2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="testing-a-range-of-interval-widths" class="level4">
<h4 class="anchored" data-anchor-id="testing-a-range-of-interval-widths">Testing a range of interval widths</h4>
<p>We can check a few values of <span class="math inline">\(R\)</span>. There is a tradeoff here of course– the wider the interval we try to approximate, the worse the approximation will be. But if the interval is too narrow, the polynomial approximate likelihood essentially does not support data that fall far outside the interval. This is because we require the highest odd degree coefficient of our polynomial to be <span class="math inline">\(&lt;0\)</span> otherwise the likelihood grows unbounded outside the interval, and the approximation is not integrable.</p>
<div class="cell" data-hash="index_cache/html/fit-logistic-vary-R-k2_b8e4e51fdc6989f70a5c5c7d668549c9">

</div>
<div class="cell" data-hash="index_cache/html/plot-logistic-vary-R-k2_6b2eedf61504c2bf9cb9ea83f3bf95d4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(q_R3, b, <span class="at">main=</span><span class="st">'R=3'</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(q_R5, b, <span class="at">main=</span><span class="st">'R=5'</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(q_R7, b, <span class="at">main=</span><span class="st">'R=7'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot-logistic-vary-R-k2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="higher-degree-approximations" class="level3">
<h3 class="anchored" data-anchor-id="higher-degree-approximations">Higher degree approximations</h3>
<p>Now we will extend our implementation above to handle higher degree approximations. This involves computing higher moments of the effect predictions, which isn’t too hard for Gaussian distributions.</p>
<div class="cell" data-hash="index_cache/html/polynomial-logistic-regression_f066e18f2e029c981b1de94a6562604e">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Make shift matrix</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Generate matrix that maps coefficients of a polynomial</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' f(x + y) (represented by coefficients p) to coefficients of</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' f2(x) = E_{p(y)}[f(x+y)]</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param moments moments of y</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>make_shift_matrix <span class="ot">&lt;-</span> <span class="cf">function</span>(moments){</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># construct map</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">length</span>(moments) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow=</span> K<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol=</span>K<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>K){</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>K){</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>      M[j<span class="sc">+</span><span class="dv">1</span>, k<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">choose</span>(k, j) <span class="sc">*</span> moments[[<span class="fu">max</span>(k<span class="sc">-</span>j<span class="sc">+</span><span class="dv">1</span>, <span class="dv">1</span>)]]</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(M)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">#' Transform coefficients of a polynomial f(x + y) (represented by coefficients p)</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' to coefficients of f2(x) = E_{p(y)}[f(x+y)]</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param p K+1 coefficients of a degree-k polynomial</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param moments moments of y (including E[y^0] = 1)</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>shift_polynomial3 <span class="ot">&lt;-</span> <span class="cf">function</span>(p, moments){</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">make_shift_matrix</span>(moments)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>  p_new <span class="ot">&lt;-</span> (M <span class="sc">%*%</span> p)[, <span class="dv">1</span>]</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p_new)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>compute_normal_moments <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, var, k){</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(purrr<span class="sc">::</span><span class="fu">map_dbl</span>(<span class="dv">0</span><span class="sc">:</span>k, <span class="sc">~</span>actuar<span class="sc">::</span><span class="fu">mnorm</span>(.x, mu, <span class="fu">sqrt</span>(var))))</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="co">#' compute k moments for psi = xb, b ~ N(mu, var)</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>compute_psi_moments <span class="ot">&lt;-</span> <span class="cf">function</span>(x, mu, var, k){</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>  normal_moments <span class="ot">&lt;-</span> <span class="fu">compute_normal_moments</span>(mu, var, k)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>  psi_moments <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind, purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">0</span><span class="sc">:</span>k, <span class="sc">~</span> (x<span class="sc">**</span>.x) <span class="sc">*</span> normal_moments[.x <span class="sc">+</span> <span class="dv">1</span>]))</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="co">#' update q with polynomial approximation of arbitrary degree</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>polynomial_update3 <span class="ot">&lt;-</span> <span class="cf">function</span>(m, X, prior_p, q){</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">ncol</span>(m) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>    m_tilde <span class="ot">&lt;-</span> m</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> (<span class="dv">1</span><span class="sc">:</span>p)[<span class="sc">-</span>j]){</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>      moments <span class="ot">&lt;-</span> <span class="fu">compute_psi_moments</span>(X[, k], q[[k]]<span class="sc">$</span>mu, q[[k]]<span class="sc">$</span>var, K)</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>      m_tilde <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(i) <span class="fu">shift_polynomial3</span>(</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>        m_tilde[i,], moments[i,])))</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale-- new polynomial in terms of b_j</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    m_hat <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(i) <span class="fu">scale_polynomial</span>(</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>      m_tilde[i,], X[i, j])))</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute posterior polynomial</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>    m_post <span class="ot">&lt;-</span> <span class="fu">colSums</span>(m_hat) <span class="sc">+</span> prior_p[[j]]</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># find gaussian approximation</span></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>    q[[j]] <span class="ot">&lt;-</span> <span class="fu">poly_to_gaussian</span>(m_post)</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>    q[[j]]<span class="sc">$</span>m_post <span class="ot">&lt;-</span> m_post</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(q)</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>logistic_polynomial_approximation <span class="ot">&lt;-</span> <span class="cf">function</span>(y, X, R, <span class="at">K=</span><span class="dv">2</span>){</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># observations in polynomial coeeficients</span></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">bernoulli_poly_approx</span>(y, R, K)</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>  prior_p <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>    prior_p[[j]] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>), <span class="fu">rep</span>(<span class="dv">0</span>, K<span class="dv">-2</span>)) <span class="co"># extend polynomial to agree with m</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>    q[[j]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">var=</span><span class="dv">1</span>) <span class="co"># initialize normal posterior</span></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># iteratively update</span></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>  param_history <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>  param_history[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> q</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>){</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>    q <span class="ot">&lt;-</span> <span class="fu">polynomial_update3</span>(m, X, prior_p, q)</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>    param_history[[i<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> q</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(param_history)</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compare-implimentations" class="level3">
<h3 class="anchored" data-anchor-id="compare-implimentations">Compare implimentations</h3>
<p>The two implimentations agree!</p>
<div class="cell" data-hash="index_cache/html/compare-k2-and-any-k-implimentations_92b9da36835d6d5f19e780a4268f4cd9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">simulate_lr</span>(<span class="at">p=</span><span class="dv">3</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> sim<span class="sc">$</span>y</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> sim<span class="sc">$</span>X</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> sim<span class="sc">$</span>b</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>qs_2 <span class="ot">&lt;-</span> <span class="fu">logistic_polynomial_approximation_k2</span>(y, X, <span class="at">R=</span><span class="dv">10</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>qs_k2 <span class="ot">&lt;-</span> <span class="fu">logistic_polynomial_approximation</span>(y, X, <span class="at">R=</span><span class="dv">10</span>, <span class="at">K=</span><span class="dv">2</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(qs_2[[<span class="dv">51</span>]], b, <span class="at">main=</span><span class="st">'A'</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(qs_k2[[<span class="dv">51</span>]], b, <span class="at">main=</span><span class="st">'B'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/compare-k2-and-any-k-implimentations-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="how-does-the-posterior-approximation-change-as-we-increase-degree" class="level3">
<h3 class="anchored" data-anchor-id="how-does-the-posterior-approximation-change-as-we-increase-degree">How does the posterior approximation change as we increase degree?</h3>
<p>We approximate the likelihood on <span class="math inline">\([-10, 10]\)</span> with <span class="math inline">\(K=2,6,10,14\)</span>. Note the polynomial approximation cannot be e.g.&nbsp;degree <span class="math inline">\(4\)</span> because these polynomials are unbounded above (<span class="math inline">\(c_4 &gt;0\)</span>), so <span class="math inline">\(e^ \hat f(x)\)</span> is not integrable over the real line. But <span class="math inline">\(c_K &lt; 0\)</span> for approximations of degree <span class="math inline">\(K = 2z + 2\)</span> for <span class="math inline">\(z \in \mathbb N\)</span>.</p>
<p>In this example it seems that with <span class="math inline">\(K=2\)</span> we tend to over-estimate the effect size, but this is resolved in the higher degree approximations.</p>
<div class="cell" data-hash="index_cache/html/fit-logistic-vary-k_ee6911c651648556b7f65cf9c3f429e9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">simulate_lr</span>(<span class="at">p=</span><span class="dv">3</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> sim<span class="sc">$</span>y</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> sim<span class="sc">$</span>X</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> sim<span class="sc">$</span>b</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>qs_k2 <span class="ot">&lt;-</span> <span class="fu">logistic_polynomial_approximation</span>(y, X, <span class="at">R=</span><span class="dv">10</span>, <span class="at">K=</span><span class="dv">2</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>qs_k6 <span class="ot">&lt;-</span> <span class="fu">logistic_polynomial_approximation</span>(y, X, <span class="at">R=</span><span class="dv">10</span>, <span class="at">K=</span><span class="dv">6</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>qs_k10 <span class="ot">&lt;-</span> <span class="fu">logistic_polynomial_approximation</span>(y, X, <span class="at">R=</span><span class="dv">10</span>, <span class="at">K=</span><span class="dv">10</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>qs_k14 <span class="ot">&lt;-</span> <span class="fu">logistic_polynomial_approximation</span>(y, X, <span class="at">R=</span><span class="dv">10</span>, <span class="at">K=</span><span class="dv">14</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(qs_k2[[<span class="dv">51</span>]], b, <span class="at">main=</span><span class="st">'K=2'</span>)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(qs_k6[[<span class="dv">51</span>]], b, <span class="at">main=</span><span class="st">'K=6'</span>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(qs_k10[[<span class="dv">51</span>]], b, <span class="at">main=</span><span class="st">'K=10'</span>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(qs_k14[[<span class="dv">51</span>]], b, <span class="at">main=</span><span class="st">'K=14'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/fit-logistic-vary-k-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="poisson-regression-example" class="level2">
<h2 class="anchored" data-anchor-id="poisson-regression-example">Poisson regression example</h2>
<section id="impliment" class="level3">
<h3 class="anchored" data-anchor-id="impliment">Impliment</h3>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-1_bb3230c1642b04b7eeba9377560ff2b2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>poisson_ll <span class="ot">&lt;-</span> <span class="cf">function</span>(y){</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="cf">function</span>(psi) <span class="fu">dpois</span>(y, <span class="fu">exp</span>(psi), <span class="at">log =</span> T)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(f)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>poisson_approx <span class="ot">&lt;-</span> <span class="cf">function</span>(y, R, k, <span class="at">as_function=</span>F){</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">poisson_ll</span>(y)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">make_approximation</span>(f, R, k, <span class="at">plot =</span> F)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(as_function){</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    p2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">polyval2</span>(p, x)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(p2)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>poisson_poly_approx <span class="ot">&lt;-</span> <span class="cf">function</span>(y, R, k){</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  unique_counts <span class="ot">&lt;-</span> <span class="fu">unique</span>(y)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>  polynomials <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(yy <span class="cf">in</span> unique_counts){</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    polynomials[[yy <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">poisson_approx</span>(yy, R, k)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, purrr<span class="sc">::</span><span class="fu">map</span>(y, <span class="sc">~</span>polynomials[[.x <span class="sc">+</span> <span class="dv">1</span>]]))</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(m)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>poisson_regression_polynomial_approximation <span class="ot">&lt;-</span> <span class="cf">function</span>(y, X, R, <span class="at">K=</span><span class="dv">2</span>){</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># observations in polynomial coeeficients</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tic</span>()</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">poisson_poly_approx</span>(y, R, K)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>  prior_p <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    prior_p[[j]] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>), <span class="fu">rep</span>(<span class="dv">0</span>, K<span class="dv">-2</span>)) <span class="co"># extend polynomial to agree with m</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    q[[j]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">var=</span><span class="dv">1</span>) <span class="co"># initialize normal posterior</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># iteratively update</span></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>  param_history <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>  param_history[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> q</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>){</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    q <span class="ot">&lt;-</span> <span class="fu">polynomial_update3</span>(m, X, prior_p, q)</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    param_history[[i<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> q</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toc</span>()</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(param_history)</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="visualize-approximation" class="level3">
<h3 class="anchored" data-anchor-id="visualize-approximation">Visualize approximation</h3>
<p>We approximation <span class="math inline">\(f(\psi) = Pois(y=3; \lambda = e^\psi)\)</span> using polynomials of increasing degree on the interval <span class="math inline">\([-5, 5]\)</span></p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-2_c780e01573d5c38c3246c846ce5c7014">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">poisson_ll</span>(<span class="dv">3</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># polynomial approximation via pracma</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>f_k2 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(f, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">2</span>)<span class="sc">$</span>p)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>f_k4 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(f, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">4</span>)<span class="sc">$</span>p)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>f_k8 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(f, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">8</span>)<span class="sc">$</span>p)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>f_k16 <span class="ot">&lt;-</span> <span class="fu">rev</span>(pracma<span class="sc">::</span><span class="fu">polyApprox</span>(f, <span class="sc">-</span>R, R, <span class="at">n =</span> <span class="dv">16</span>)<span class="sc">$</span>p)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> R <span class="sc">+</span> <span class="dv">2</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span>S, S, <span class="at">by=</span><span class="fl">0.1</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(f, <span class="sc">-</span>S, S)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">polyval2</span>(f_k2, x), <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="st">'dotted'</span>)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">polyval2</span>(f_k4, x), <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="st">'dotted'</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">polyval2</span>(f_k8, x), <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="st">'dotted'</span>)</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">polyval2</span>(f_k16, x), <span class="at">col=</span><span class="st">'orange'</span>, <span class="at">lty=</span><span class="st">'dotted'</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>R); <span class="fu">abline</span>(<span class="at">v=</span><span class="sc">-</span>R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="simulate-poisson-regression" class="level3">
<h3 class="anchored" data-anchor-id="simulate-poisson-regression">Simulate poisson regression</h3>
<div class="cell" data-hash="index_cache/html/simulate-lr_9459d42e5b28f7ae7507a6a53c670d5d">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>simulate_poisson_regression <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">500</span>, <span class="at">p=</span><span class="dv">2</span>, <span class="at">lenghtscale =</span> <span class="fl">0.8</span>, <span class="at">prior_variance=</span><span class="dv">1</span>){</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>p), <span class="at">nrow=</span>n)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="fu">outer</span>(<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="st">'-'</span>)<span class="sc">/</span>lenghtscale)<span class="sc">**</span><span class="dv">2</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> Z <span class="sc">%*%</span> K</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p) <span class="sc">*</span> <span class="fu">sqrt</span>(prior_variance)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  logrates <span class="ot">&lt;-</span> (X <span class="sc">%*%</span> b)[, <span class="dv">1</span>]</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="fu">length</span>(logrates), <span class="fu">exp</span>(logrates))</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">y=</span>y, <span class="at">X=</span>X, <span class="at">b=</span>b, <span class="at">logrates=</span>logrates))</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">simulate_poisson_regression</span>(<span class="at">p=</span><span class="dv">4</span>, <span class="at">prior_variance =</span> <span class="dv">1</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> sim<span class="sc">$</span>y</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> sim<span class="sc">$</span>X</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> sim<span class="sc">$</span>b</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.3296046  0.6149598  0.7740477  0.2643521</code></pre>
</div>
</div>
</section>
<section id="example-1" class="level3">
<h3 class="anchored" data-anchor-id="example-1">Example</h3>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_bb3fff04b22847e9d9f937e3f6de779d">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>pois_R5_K2 <span class="ot">&lt;-</span> <span class="fu">poisson_regression_polynomial_approximation</span>(y, X, <span class="at">R=</span><span class="dv">5</span>, <span class="at">K=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>6.152 sec elapsed</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>pois_R5_K4 <span class="ot">&lt;-</span> <span class="fu">poisson_regression_polynomial_approximation</span>(y, X, <span class="at">R=</span><span class="dv">5</span>, <span class="at">K=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>9.306 sec elapsed</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>pois_R5_K8 <span class="ot">&lt;-</span> <span class="fu">poisson_regression_polynomial_approximation</span>(y, X, <span class="at">R=</span><span class="dv">5</span>, <span class="at">K=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>20.818 sec elapsed</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>pois_R5_K16 <span class="ot">&lt;-</span> <span class="fu">poisson_regression_polynomial_approximation</span>(y, X, <span class="at">R=</span><span class="dv">5</span>, <span class="at">K=</span><span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>61.81 sec elapsed</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(pois_R5_K2[[<span class="dv">51</span>]], b, <span class="at">main=</span><span class="st">'K=2'</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(pois_R5_K4[[<span class="dv">51</span>]], b, <span class="at">main=</span><span class="st">'K=4'</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(pois_R5_K8[[<span class="dv">51</span>]], b, <span class="at">main=</span><span class="st">'K=8'</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(pois_R5_K16[[<span class="dv">51</span>]], b, <span class="at">main=</span><span class="st">'K=16'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_e33d8446716552c2c16bdd2aed6215e3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_effect_posterior</span>(pois_R5_K2[[<span class="dv">51</span>]], sim<span class="sc">$</span>b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">map_dbl</span>(pois_R5_K2[[<span class="dv">51</span>]], <span class="sc">~</span>purrr<span class="sc">::</span><span class="fu">pluck</span>(.x, <span class="st">'mu'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.51427519  0.50936054  0.92844494  0.08298042</code></pre>
</div>
</div>
</section>
</section>
<section id="higher-degree-polynomial-posterior-q" class="level2">
<h2 class="anchored" data-anchor-id="higher-degree-polynomial-posterior-q">Higher degree polynomial posterior <span class="math inline">\(q\)</span></h2>
<p>In the above implementation we compute a polynomial proportional to the posterior density, but reduce this to a Gaussian approximation by taking a Laplace approximation.</p>
<p>That is we want to compute</p>
<p><span class="math display">\[
\mathbb E [b^j] = \int_{\mathbb R} b^j q(b)
\]</span></p>
<p>Which we approximate by</p>
<p><span class="math display">\[
\mathbb E [b^j] \approx \int_{\mathbb R} b^j q_{\text{gauss}}(b)
\]</span></p>
<p>Where <span class="math inline">\(q_{\text{gauss}}\)</span> is the Gaussian distribution that minimizes the divergence to <span class="math inline">\(q_{\text{gauss}} = \arg \min_{q_g} KL(q_g ||q)\)</span>.</p>
<p>It would be better if we could compute the moments of <span class="math inline">\(q(b_l) \propto \exp\{\sum_k \eta_k b_l^k\}\)</span>. We define the log normalizing constant <span class="math inline">\(A({\bf \eta}) = \log \int \exp\{\sum_{k=0}^K \eta_k b_l^k\} db\)</span>. Let <span class="math inline">\(f(b) = \sum_{k=0}^K \eta_k b^k - A(\eta)\)</span> so that <span class="math inline">\(q(b) = \exp\{f(b)}\)</span>.</p>
<p>Because <span class="math inline">\(q\)</span> is in an exponential family, we know that <span class="math inline">\(\nabla_{\eta} A(\eta) = \mathbb E[T(x)] = [1, \mathbb E[b], \mathbb E[b^2], \dots, \mathbb E[b^K]]\)</span>. Is there an easy way to compute the gradient of <span class="math inline">\(A\)</span>?</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>